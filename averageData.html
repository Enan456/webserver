<!DOCTYPE html>
<html lang="en">

<head>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link type="text/css" rel="stylesheet" href="assets/css/materialize.css" media="screen,projection" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="theme-color" content="#02243E" />
    <link href="https://fonts.googleapis.com/css?family=Roboto" rel="stylesheet">
    <meta name="Description" content="GearScout - The Scouting App For Any Team">
    <script src="https://www.gstatic.com/firebasejs/5.0.0/firebase.js"></script>
    <script type="text/javascript" src="assets/js/materialize.js"></script>
    <style src="assets/css/bootstrap.min.css"></style>
    <style src="assets/css/style.css"></style>
    <link type="text/css" rel="stylesheet" href="assets/css/sgdata.css" rel="stylesheet">
    <style src="assets/css/materialize.css"></style>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.bundle.min.js"></script>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-112760702-1"></script>
    <script src="interim.js"></script>
    <script>
        var config = {
        apiKey: "AIzaSyAGjIhyS5eGmUvZysE46CuWFjeX0T-ykWA",
        authDomain: "scoutgear-2018.firebaseapp.com",
        databaseURL: "https://scoutgear-2018.firebaseio.com",
        projectId: "scoutgear-2018",
        storageBucket: "scoutgear-2018.appspot.com",
        messagingSenderId: "269363065314"
    };
    firebase.initializeApp(config);
    var database = firebase.database();

        window.dataLayer = window.dataLayer || [];

    function gtag() {
        dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-112760702-1');
</script>
    <script src="assets/js/sg.js"></script>
    <script src="assets/js/service_worker.js"></script>
    <link rel="apple-touch-icon" sizes="180x180" href="/assets/images/icons/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="32x32" href="/assets/images/icons/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/assets/images/icons/favicon-16x16.png">
    <link rel="manifest" href="manifest.json">
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <head>
        <style>
            ul {
            list-style-type: none;
            margin: 0;
            padding: 0;
            overflow: hidden;
            background-color: #8a9385;
            border-radius: 40px;
            border-color: white;
            width: 90%;
          }
          
          li {
            float: left;
          }
          
          li a {
            display: block;
            color: white;
            text-align: center;
            padding: 16px 16px;
            text-decoration: none;
            font-family: 'Roboto', sans-serif;
          }
          
          li a:hover:not(.active) {
            background-color: #717a6c;
            font-family: 'Roboto', sans-serif;
          }
          
          .active1 {
            background-color: #FE5000;
          }
          </style>
    </head>

<body>
    <center>
        <div class="meh">
            <ul>
                <li><b><a class="active1">GearData Average</a></b></li>
                <li><a href="https://enan.rocks/gearscout">GearScout</a></li>
                <li><a href="https://enan.rocks/geardata">GearData</a></li>
                <li><a href="https://github.com/Enan456/webserver">Github</a></li>
                <li><a href="http://oswegofirst.org">Team Website</a></li>
                <li><a href="https://enan.rocks/graph">Graph</a></li>
                <li><a href="https://enan.rocks/gbp">Good Bot Points</a></li>
                <li><a href="https://docs.google.com/forms/d/e/1FAIpQLScjU4cU_DMEYTVckf24ngp1Zs-B5Zo6tQvfsxH7lijaLMVP6A/viewform?usp=sf_link">Bug
                        Report</a></li>
            </ul>
        </div>
    </center>
    <center>
        <!-- Use these form inputs to grab data -->
        <div class="margin-main">

            <div class="input-field col-md-6 col-sm-12">
                <input id="yourteam" type="text" class="validate">
                <label for="yourteam">Team You Are In</label>
            </div>
            <div class="input-field col-md-12 col-sm-12">
                <input id="regional" type="text" class="validate">
                <label for="regional">Regional Code</label>
            </div>
            <button class="btn waves-effect waves-light" type="submit" onclick=load_data()>Get Data
                <i class="material-icons right">send</i>
            </button>

            <br><br><br>

            <table id="dataTable">
                <tr>
                    <th>Team Number</th>
                    <th>Average Cargo</th>
                    <th>Average Hatches</th>
                    <th>Highest Cargo</th>
                    <th>Highest Hatches</th>
                    <th>Match Number</th>
                    <th>Starting Platform</th>
                    <th>Cargo</th>
                    <th>Hatches</th>
                    <th>Ending Platfrom</th>
                </tr>
            </table>

            <br><br><br>

            <script>
                var teamNum;

                var avgCargo;
                var avgHatch;

                var highCargo;
                var highHatch;

                var matchNum;
                var totalMatch;

                var allMatches;

                var startPlat;
                var matchCargo;
                var matchHatch;
                var endPlat;

                class Match {
                    constructor(num, start, cargo, hatch, end) {
                        this.num = num;
                        this.start = start;
                        this.cargo = cargo;
                        this.hatch = hatch;
                        this.end = end;
                    }

                    getHTML() {
                        return '<td></td><td></td><td></td><td></td><td></td><td>' + this.num + '</td>' +
                            '<td>' + this.start + '</td>' +
                            '<td>' + this.cargo + '</td>' +
                            '<td>' + this.hatch + '</td>' +
                            '<td>' + this.end + '</td>';
                    };
                }

                function load_data() {
                    const yourTeam = document.getElementById("yourteam").value;
                    const regional = document.getElementById("regional").value;

                    var userDataRef = firebase.database().ref("/" + yourTeam + "/" + regional).orderByKey();
                    userDataRef.once("value").then(function (teams) {
                        teams.forEach(function (team) {
                            teamNum = team.key;
                            totalMatch = 0;
                            allMatches = [];
                            avgCargo = 0;
                            avgHatch = 0;
                            highCargo = 0;
                            highHatch = 0;
                            team.forEach(function (match) {
                                totalMatch ++;
                                matchNum = match.key;
                                match.forEach(function (tag) {
                                    startPlat = "N/A";
                                    endPlat = "N/A";
                                    if (tag.val().Slvl1Platform == "true") {
                                        startPlat = "Level 1";
                                    } else if (tag.val().Slvl2PlatformL == "true" || tag.val().Slvl2PlatformR == "true") {
                                        startPlat = "Level 2";
                                    } else if (tag.val().Slvl3Platform == "true") {
                                        startPlat = "Level 3";
                                    }
                                    if (tag.val().lvl1Platform == "true") {
                                        endPlat = "Level 1";
                                    } else if (tag.val().lvl2PlatformL == "true" || tag.val().lvl2PlatformR == "true") {
                                        endPlat = "Level 2";
                                    } else if (tag.val().lvl3Platform == "true") {
                                        endPlat = "Level 3";
                                    }
                                    matchCargo = 0;
                                    matchHatch = 0;
                                    if (tag.val().order != undefined) {
                                        tag.val().order.forEach(function (elem) {
                                            if (elem.indexOf("Cargo") !== -1) {
                                                matchCargo ++;
                                            }
                                            if (elem.indexOf("Hatch") !== -1) {
                                                matchHatch ++;
                                            }
                                        });
                                    }
                                });
                                avgCargo += matchCargo;
                                avgHatch += matchHatch;
                                if (matchCargo > highCargo) {
                                    highCargo = matchCargo;
                                }
                                if (matchHatch > highHatch) {
                                    highHatch = matchHatch;
                                }
                                allMatches.push(new Match(matchNum, startPlat, matchCargo, matchHatch, endPlat));
                            });
                            avgCargo /= totalMatch;
                            avgHatch /= totalMatch;
                            document.getElementById("dataTable").innerHTML += '<tr><td rowspan="' + totalMatch + '">' +
                                teamNum + '</td><td rowspan="' + totalMatch + '">' + avgCargo.toFixed(2) + '</td><td rowspan="' +
                                totalMatch + '">' + avgHatch.toFixed(2) + '</td><td rowspan="' + totalMatch + '">' + highCargo +
                                '</td><td rowspan="' + totalMatch + '">' + highHatch + '</td>' + allMatches[0].getHTML() + '</tr>';
                            for (var i = 1; i < allMatches.length; i ++) {
                                document.getElementById("dataTable").innerHTML += '<tr>' + allMatches[i].getHTML() + '</tr>';
                            }
                        });
                    });
                };
            </script>
        </div>
    </center>
</body>

</html>
